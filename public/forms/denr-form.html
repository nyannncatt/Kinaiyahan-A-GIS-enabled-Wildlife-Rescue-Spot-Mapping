<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PRINT REPORT</title>
<link rel="icon" type="image/png" href="/images/kinaiyahanlogonobg.png" sizes="16x16">
<link rel="icon" type="image/png" href="/images/kinaiyahanlogonobg.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/kinaiyahanlogonobg.png" sizes="48x48">
<link rel="icon" type="image/png" href="/images/kinaiyahanlogonobg.png" sizes="64x64">
<link rel="apple-touch-icon" href="/images/kinaiyahanlogonobg.png" sizes="180x180">
<style>
  body {
    font-family: "Times New Roman", serif;
    background-color: #fff;
    margin: 40px 2.54cm;
  }

  /* Screen-only background theme copied from Public Report */
  @media screen {
    html, body {
      height: 100%;
      overflow: hidden; /* remove page scroll on site */
    }
    body {
      background: linear-gradient(135deg, #ffffff 0%, #e8f5e8 50%, #4caf50 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      background-size: 200% 200%;
      animation: bgShift 10s ease-in-out infinite alternate;
    }
    .container {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      padding: 40px;
      max-width: 800px;
      max-height: calc(100vh - 80px); /* keep within viewport */
      overflow: hidden; /* prevent inner scroll */
      opacity: 0;
      transform: translateY(12px) scale(0.98);
      animation: fadeInUp 500ms cubic-bezier(0.22, 1, 0.36, 1) 120ms forwards;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes bgShift {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    /* Animated background species (standalone CSS for this page) */
    .bg-animals {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      z-index: 0;
    }
    .bg-animals .animal {
      position: absolute;
      font-size: 22px;
      opacity: 0.7;
      filter: saturate(0.9) drop-shadow(0 2px 2px rgba(0,0,0,0.12));
      animation-timing-function: linear;
      animation-iteration-count: infinite;
      white-space: pre;
    }
    .bg-animals .animal.rtl { right: -10%; }
    .bg-animals .animal.ltr { left: -10%; }

    @keyframes popFloatA {
      0% { transform: translateX(0) translateY(0) scale(0.6) rotate(0deg); opacity: 0; }
      8% { opacity: 0.7; }
      25% { transform: translateX(-25vw) translateY(-6px) scale(0.9) rotate(-2deg); }
      50% { transform: translateX(-55vw) translateY(4px) scale(1.0) rotate(1deg); }
      75% { transform: translateX(-85vw) translateY(-3px) scale(0.95) rotate(-1deg); }
      100% { transform: translateX(-115vw) translateY(0) scale(0.9) rotate(0deg); opacity: 0; }
    }
    @keyframes popFloatB {
      0% { transform: translateX(0) translateY(0) scale(0.6) rotate(0deg); opacity: 0; }
      8% { opacity: 0.7; }
      25% { transform: translateX(25vw) translateY(6px) scale(0.9) rotate(2deg); }
      50% { transform: translateX(55vw) translateY(-4px) scale(1.0) rotate(-1deg); }
      75% { transform: translateX(85vw) translateY(3px) scale(0.95) rotate(1deg); }
      100% { transform: translateX(115vw) translateY(0) scale(0.9) rotate(0deg); opacity: 0; }
    }
    @keyframes zigZagA {
      0% { transform: translateX(0) translateY(0) scale(0.7); opacity: 0; }
      10% { opacity: 0.7; }
      20% { transform: translateX(-20vw) translateY(-8px) rotate(-2deg); }
      40% { transform: translateX(-40vw) translateY(5px) rotate(2deg); }
      60% { transform: translateX(-60vw) translateY(-6px) rotate(-1deg); }
      80% { transform: translateX(-85vw) translateY(4px) rotate(1deg); }
      100% { transform: translateX(-115vw) translateY(0) scale(0.95); opacity: 0; }
    }
    @keyframes zigZagB {
      0% { transform: translateX(0) translateY(0) scale(0.7); opacity: 0; }
      10% { opacity: 0.7; }
      20% { transform: translateX(20vw) translateY(8px) rotate(2deg); }
      40% { transform: translateX(40vw) translateY(-5px) rotate(-2deg); }
      60% { transform: translateX(60vw) translateY(6px) rotate(1deg); }
      80% { transform: translateX(85vw) translateY(-4px) rotate(-1deg); }
      100% { transform: translateX(115vw) translateY(0) scale(0.95); opacity: 0; }
    }
    @keyframes wanderA {
      0% { transform: translate(0, 0) scale(0.8) rotate(0deg); opacity: 0; }
      10% { opacity: 0.7; }
      25% { transform: translate(-8vw, -4vh) scale(0.9) rotate(-3deg); }
      40% { transform: translate(6vw, 6vh) scale(1.0) rotate(2deg); }
      55% { transform: translate(-12vw, 10vh) scale(0.95) rotate(-2deg); }
      70% { transform: translate(10vw, -8vh) scale(1.0) rotate(1deg); }
      85% { transform: translate(-6vw, 4vh) scale(0.95) rotate(-1deg); }
      100% { transform: translate(0, 0) scale(0.9) rotate(0deg); opacity: 0; }
    }
    @keyframes wanderB {
      0% { transform: translate(0, 0) scale(0.8) rotate(0deg); opacity: 0; }
      10% { opacity: 0.7; }
      25% { transform: translate(10vw, 5vh) scale(0.95) rotate(2deg); }
      40% { transform: translate(-6vw, -8vh) scale(1.0) rotate(-2deg); }
      55% { transform: translate(12vw, -6vh) scale(0.95) rotate(1deg); }
      70% { transform: translate(-8vw, 9vh) scale(1.0) rotate(-1deg); }
      85% { transform: translate(5vw, -4vh) scale(0.98) rotate(1deg); }
      100% { transform: translate(0, 0) scale(0.9) rotate(0deg); opacity: 0; }
    }
  }
  .container {
    width: 700px;
    margin: 0 auto;
    padding-bottom: 100px;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    text-align: center;
    gap: 20px;
  }
  .header img {
    width: 90px;
    height: auto;
  }
  .header-text {
    font-weight: bold;
    font-size: 11pt;
    line-height: 1.2;
    white-space: nowrap;
    flex: 1;
    text-align: center;
  }
  .header-text span {
    display: block;
    font-size: 11pt;
    font-weight: normal;
  }
  h3 {
    margin: 20px 0 10px;
    font-size: 11pt;
    font-weight: bold;
    text-align: center;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 10px 0 20px;
  }
  th, td {
    border: 1px solid #000;
    padding: 6px;
    text-align: center;
    font-size: 11pt;
    width: 33.33%;
  }
  p {
    font-size: 11pt;
    margin: 6px 0;
  }
  .underline {
    display: inline-block;
    border-bottom: 1px solid #000;
    min-width: 150px;
  }
  
  .fillable {
    border: none;
    border-bottom: 1px solid #000;
    background-color: transparent;
    outline: none;
    font-family: "Times New Roman", serif;
    font-size: 11pt;
    padding: 0 4px;
    min-width: 150px;
    height: auto;
    vertical-align: text-bottom;
    line-height: 1;
  }
  
  .print-button {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
    z-index: 1000;
  }
  
  .print-button:hover {
    background-color: #0056b3;
  }
  
  @media print {
    .print-button {
      display: none;
    }
    #savedByInfo {
      display: none !important;
    }
    .bg-animals {
      display: none !important;
    }
    .animal {
      display: none !important;
    }
    
    @page {
      margin: 0 2.54cm;
      size: A4;
    }
    
    body {
      margin: 0;
      padding: 20px;
    }
    
    .container {
      margin: 0 auto;
      width: 100%;
      max-width: 800px;
    }
  }
</style>
</head>
<body>
<!-- Animated background endangered species -->
<div class="bg-animals" aria-hidden="true">
  <!-- Right -> Left -->
  <span class="animal rtl" title="Philippine Eagle" style="top: 10%; animation-duration: 22s; animation-delay: 0s; animation-name: popFloatA;">🦅</span>
  <span class="animal rtl" title="Philippine Crocodile" style="top: 22%; animation-duration: 27s; animation-delay: 0s; animation-name: zigZagA;">🐊</span>
  <span class="animal rtl" title="Whale Shark" style="top: 34%; animation-duration: 24s; animation-delay: 0s; animation-name: popFloatA;">🦈</span>
  <span class="animal rtl" title="Philippine Eagle-Owl" style="top: 46%; animation-duration: 29s; animation-delay: 0s; animation-name: zigZagA;">🦉</span>
  <span class="animal rtl" title="Philippine Deer" style="top: 58%; animation-duration: 26s; animation-delay: 0s; animation-name: popFloatA;">🦌</span>
  <!-- Left -> Right -->
  <span class="animal ltr" title="Hawksbill Turtle" style="top: 16%; animation-duration: 24s; animation-delay: 0s; animation-name: popFloatB;">🐢</span>
  <span class="animal ltr" title="Tamaraw" style="top: 28%; animation-duration: 26s; animation-delay: 0s; animation-name: zigZagB;">🐃</span>
  <span class="animal ltr" title="Visayan Warty Pig" style="top: 40%; animation-duration: 23s; animation-delay: 0s; animation-name: popFloatB;">🐗</span>
  <span class="animal ltr" title="Philippine Tarsier" style="top: 52%; animation-duration: 29s; animation-delay: 0s; animation-name: zigZagB;">🐵</span>
  <span class="animal ltr" title="Philippine Hornbill" style="top: 64%; animation-duration: 27s; animation-delay: 0s; animation-name: popFloatB;">🐦</span>
  <!-- Wanderers -->
  <span class="animal" title="Philippine Freshwater Crocodile" style="top: 12%; left: 8%; animation-duration: 26s; animation-delay: 0s; animation-name: wanderA; animation-direction: alternate;">🐊</span>
  <span class="animal" title="Rufous Hornbill" style="top: 72%; left: 12%; animation-duration: 28s; animation-delay: 0s; animation-name: wanderB; animation-direction: alternate;">🐦</span>
  <span class="animal" title="Palawan Peacock-Pheasant" style="top: 44%; left: 18%; animation-duration: 24s; animation-delay: 0s; animation-name: wanderA; animation-direction: alternate;">🦚</span>
  <span class="animal" title="Green Sea Turtle" style="top: 26%; left: 70%; animation-duration: 30s; animation-delay: 0s; animation-name: wanderB; animation-direction: alternate;">🐢</span>
</div>
<button class="print-button" onclick="printForm()">Print Form</button>
<button class="print-button" style="right: 140px; background-color: #2e7d32" onclick="saveForm()">Save</button>
<div class="container" style="position: relative; z-index: 1;">

  <br>
  <!-- Header Section -->
  <div class="header">
    <img src="/images/denrlogo.png" alt="DENR Logo">
    <div class="header-text">
      DEPARTMENT OF ENVIRONMENT AND NATURAL RESOURCES
      <span>KAGAWARAN NG KAPALIGARAN AT LIKAS YAMAN</span>
    </div>
    <img src="/images/bagongpilipinaslogo.png" alt="Bagong Pilipinas Logo">
  </div>

  <br>
  <br>
  <br>
   <!-- LEFT-ALIGNED CODE -->
   <p style="text-align:left;"><span contenteditable="true" style="outline: none; padding: 2px;">CODE-DENR-CENRO B340</span> <input type="text" class="fillable" style="width:200px; margin-left: 10px;"></p>

   <br>
   <br>
   <h3 contenteditable="true" style="outline: none; padding: 2px;">ACKNOWLEDGEMENT RECEIPT OF TURN-OVER WILDLIFE</h3>

   <!-- CENTERED ACKNOWLEDGEMENT PARAGRAPH -->
   <p style="text-align:center; line-height:1.8;">
     <span contenteditable="true" style="outline: none; padding: 2px;">THIS IS TO ACKNOWLEDGE THE RECEIPT OF the following wildlife species turn-over to</span>
   </p>
  <p style="text-align:center; line-height:1.8;">
    <input type="text" class="fillable" style="width:150px;"> <span contenteditable="true" style="outline: none; padding: 2px;">on</span> 
    <input type="text" class="fillable" style="width:150px;"> <span contenteditable="true" style="outline: none; padding: 2px;">for</span> 
    <input type="text" class="fillable" style="width:150px;">
  </p>

  <table>
    <tr>
      <th contenteditable="true" style="outline: none; padding: 2px;">SPECIES</th>
      <th contenteditable="true" style="outline: none; padding: 2px;">SCIENTIFIC NAME</th>
      <th contenteditable="true" style="outline: none; padding: 2px;">QUANTITY</th>
    </tr>
    <tr>
      <td><input type="text" class="fillable" style="width:100%; border:none; background:transparent; text-align:center;"></td>
      <td><input type="text" class="fillable" style="width:100%; border:none; background:transparent; text-align:center;"></td>
      <td><input type="text" class="fillable" style="width:100%; border:none; background:transparent; text-align:center;"></td>
    </tr>
    <tr>
      <td><input type="text" class="fillable" style="width:100%; border:none; background:transparent; text-align:center;"></td>
      <td><input type="text" class="fillable" style="width:100%; border:none; background:transparent; text-align:center;"></td>
      <td><input type="text" class="fillable" style="width:100%; border:none; background:transparent; text-align:center;"></td>
    </tr>
    <tr>
      <td><input type="text" class="fillable" style="width:100%; border:none; background:transparent; text-align:center;"></td>
      <td><input type="text" class="fillable" style="width:100%; border:none; background:transparent; text-align:center;"></td>
      <td><input type="text" class="fillable" style="width:100%; border:none; background:transparent; text-align:center;"></td>
    </tr>
  </table>
<BR>
  <p><span contenteditable="true" style="outline: none; padding: 2px;">ORIGIN OF WILDLIFE:</span> <input type="text" class="fillable" style="width:250px;"></p>
  <p><span contenteditable="true" style="outline: none; padding: 2px;">CONDITION OF WILDLIFE:</span> <input type="text" class="fillable" style="width:400px;"></p>
  <p><span contenteditable="true" style="outline: none; padding: 2px;">REMARKS:</span> <input type="text" class="fillable" style="width:400px;"></p>
  <p><span contenteditable="true" style="outline: none; padding: 2px;">RECEIVED BY:</span> <input type="text" class="fillable" style="width:250px;"></p>
  <p><span contenteditable="true" style="outline: none; padding: 2px;">TURNED OVER BY:</span> <input type="text" class="fillable" style="width:250px;"></p>
  <p><span contenteditable="true" style="outline: none; padding: 2px;">WITNESS BY:</span> <input type="text" class="fillable" style="width:250px;"></p>

  <p><span contenteditable="true" style="outline: none; padding: 2px;">TURNED OVER TO RESCUE ON</span> <input type="text" class="fillable" style="width:250px;"></p>
  <p><span contenteditable="true" style="outline: none; padding: 2px;">RECEIVED:</span> <input type="text" class="fillable" style="width:250px;"></p>
  <p><span contenteditable="true" style="outline: none; padding: 2px;">TURNED OVER BY:</span> <input type="text" class="fillable" style="width:250px;"></p>
  <p><span contenteditable="true" style="outline: none; padding: 2px;">RECEIVED BY:</span> <input type="text" class="fillable" style="width:250px;"></p>

  <br>
  <br>
  <!-- Footer Section -->
  <div style="position: fixed; bottom: 20px; left: 0; right: 0; text-align: center; font-family: 'Times New Roman', serif; font-size: 11pt; color: gray;">
    <p><span contenteditable="true" style="outline: none; padding: 2px;"><strong>Calanawan, Tankulan, Manolo Fortich, Bukidnon</strong></span></p>
    <p><span contenteditable="true" style="outline: none; padding: 2px;">cenromanolofortich@denr.gov.ph | Mobile No.: (+63) 917-522-8580</span></p>
  </div>

</div>

<!-- Saved By Information (Screen Only) - Outside form container -->
<div id="savedByInfo" style="display: none; position: fixed; top: 70px; right: 10px; background: transparent; color: #2e7d32; padding: 10px 15px; border-radius: 8px; font-size: 11pt; z-index: 1001; max-width: 250px;">
  <div style="font-weight: bold; margin-bottom: 4px;">Last Saved By:</div>
  <div style="font-size: 10pt; margin-bottom: 2px;"><strong>Name:</strong> <span id="savedByName"></span></div>
  <div style="font-size: 10pt; opacity: 0.9;"><strong>Role:</strong> <span id="savedByRole"></span></div>
</div>

<!-- Supabase Client -->
<script>
  // Load Supabase and expose it globally
  (function() {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
    script.onload = function() {
      window.supabaseLoaded = true;
      // The UMD build should expose createClient
      if (typeof window.supabase !== 'undefined') {
        window.supabaseReady = true;
      }
    };
    document.head.appendChild(script);
  })();
</script>
<script>
function printForm() {
  // Require save before allowing print
  try {
    if (!window.__formHasSavedOnce || window.__formIsDirty) {
      alert('Please save the form first before printing.');
      return;
    }
  } catch {}
  // Ensure all input values are visible for printing
  const inputs = document.querySelectorAll('.fillable');
  inputs.forEach(input => {
    if (input.value.trim() === '') {
      input.style.color = 'transparent';
    } else {
      input.style.color = 'black';
    }
  });
  
  // Trigger print dialog
  window.print();

  // Restore input styles shortly after the print dialog closes (print or cancel)
  setTimeout(() => {
    inputs.forEach(input => {
      input.style.color = '';
    });
  }, 150);
}

function getRecordId() {
  try { return new URLSearchParams(window.location.search).get('recordId') || 'no-record'; } catch { return 'no-record'; }
}

// Initialize Supabase client
let supabaseClient = null;
async function initSupabase() {
  try {
    // Wait for Supabase library to load
    let attempts = 0;
    while (!window.supabaseLoaded && attempts < 50) {
      await new Promise(resolve => setTimeout(resolve, 100));
      attempts++;
    }
    
    // Try to get Supabase config from localStorage (set by main app)
    const storedConfig = localStorage.getItem('supabaseConfig');
    if (!storedConfig) {
      console.log('Supabase config not found in localStorage');
      return null;
    }
    
    const config = JSON.parse(storedConfig);
    if (!config.url || !config.key) {
      console.log('Invalid Supabase config');
      return null;
    }
    
    // Try to find createClient function - Supabase UMD build exposes it differently
    let createClientFn = null;
    
    // Check various possible global names
    if (window.supabase && window.supabase.createClient) {
      createClientFn = window.supabase.createClient;
    } else if (window.supabaseJs && window.supabaseJs.createClient) {
      createClientFn = window.supabaseJs.createClient;
    } else if (window.supabase && typeof window.supabase === 'function') {
      createClientFn = window.supabase;
    } else if (window.supabase && window.supabase.default && window.supabase.default.createClient) {
      createClientFn = window.supabase.default.createClient;
    } else {
      // Try to use dynamic import as fallback
      try {
        const supabaseModule = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
        if (supabaseModule && supabaseModule.createClient) {
          createClientFn = supabaseModule.createClient;
        }
      } catch (e) {
        console.log('Could not use dynamic import:', e);
      }
    }
    
    if (!createClientFn) {
      console.log('Could not find createClient function. Available globals:', Object.keys(window).filter(k => k.toLowerCase().includes('supabase')));
      return null;
    }
    
    return createClientFn(config.url, config.key);
  } catch (e) {
    console.log('Supabase not available:', e);
    return null;
  }
}

// Get current user info
async function getCurrentUserInfo() {
  try {
    if (!supabaseClient) {
      supabaseClient = await initSupabase();
    }
    
    if (!supabaseClient) {
      return { name: 'Unknown', role: 'Unknown' };
    }
    
    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
    if (sessionError || !session?.user) {
      return { name: 'Unknown', role: 'Unknown' };
    }
    
    const userId = session.user.id;
    
    // Get user info from users table
    const { data: userData, error: userError } = await supabaseClient
      .from('users')
      .select('first_name, last_name, role')
      .eq('id', userId)
      .single();
    
    if (userError || !userData) {
      // Fallback to auth metadata
      const metadata = session.user.user_metadata || {};
      const firstName = metadata.first_name || metadata.full_name || '';
      const lastName = metadata.last_name || '';
      const name = `${firstName} ${lastName}`.trim() || session.user.email?.split('@')[0] || 'Unknown';
      const role = metadata.role || 'Unknown';
      return { name, role };
    }
    
    const firstName = userData.first_name || '';
    const lastName = userData.last_name || '';
    const name = `${firstName} ${lastName}`.trim() || session.user.email?.split('@')[0] || 'Unknown';
    const role = userData.role || 'Unknown';
    
    return { name, role };
  } catch (e) {
    console.error('Error getting user info:', e);
    return { name: 'Unknown', role: 'Unknown' };
  }
}

async function saveForm() {
  const recordId = getRecordId();
  const inputs = Array.from(document.querySelectorAll('.fillable')).map(el => el.value || '');
  const edits = Array.from(document.querySelectorAll('[contenteditable="true"]')).map(el => (el.textContent || ''));
  
  // Get current user info
  const userInfo = await getCurrentUserInfo();
  
  const payload = { 
    recordId, 
    savedAt: new Date().toISOString(), 
    inputs, 
    edits,
    savedBy: userInfo.name,
    savedByRole: userInfo.role
  };
  
  try {
    localStorage.setItem(`denrForm:${recordId}`, JSON.stringify(payload));
    alert('Form saved for record ' + recordId + '.');
    // Mark as saved and clean
    window.__formHasSavedOnce = true;
    window.__formIsDirty = false;
    
    // Update saved by info display
    updateSavedByInfo(payload);
  } catch { alert('Unable to save.'); }
}

function updateSavedByInfo(data) {
  const savedByInfo = document.getElementById('savedByInfo');
  const savedByName = document.getElementById('savedByName');
  const savedByRole = document.getElementById('savedByRole');
  
  if (savedByInfo && savedByName && savedByRole && data.savedBy && data.savedBy !== 'Unknown') {
    savedByName.textContent = data.savedBy;
    
    // Capitalize first letter of each word in role
    const formattedRole = data.savedByRole && data.savedByRole !== 'Unknown' 
      ? data.savedByRole.split(' ').map(word => 
          word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
        ).join(' ')
      : 'Unknown';
    
    savedByRole.textContent = formattedRole;
    savedByInfo.style.display = 'block';
  }
}

function loadFormIfAny() {
  const recordId = getRecordId();
  try {
    const raw = localStorage.getItem(`denrForm:${recordId}`);
    if (!raw) return;
    const data = JSON.parse(raw);
    (data.inputs || []).forEach((val, idx) => {
      const el = document.querySelectorAll('.fillable')[idx];
      if (el) el.value = val;
    });
    (data.edits || []).forEach((val, idx) => {
      const el = document.querySelectorAll('[contenteditable="true"]')[idx];
      if (el) el.textContent = val;
    });
    // Existing saved payload means user can print without saving unless they change something
    window.__formHasSavedOnce = true;
    
    // Display saved by info if available
    if (data.savedBy && data.savedBy !== 'Unknown') {
      updateSavedByInfo(data);
    }
  } catch {}
}

// Initialize Supabase and load form
(async function() {
  await initSupabase();
  loadFormIfAny();
})();

// Track dirty state: set when any field changes; cleared on save
window.__formIsDirty = false;
window.__formHasSavedOnce = window.__formHasSavedOnce || false;

function attachDirtyListeners() {
  const inputs = document.querySelectorAll('.fillable');
  inputs.forEach(el => {
    el.addEventListener('input', () => { window.__formIsDirty = true; });
    el.addEventListener('change', () => { window.__formIsDirty = true; });
  });
  const editables = document.querySelectorAll('[contenteditable="true"]');
  editables.forEach(el => {
    el.addEventListener('input', () => { window.__formIsDirty = true; });
    el.addEventListener('blur', () => { window.__formIsDirty = true; });
    el.addEventListener('keyup', () => { window.__formIsDirty = true; });
  });
}

attachDirtyListeners();

// Prevent accidental close if there are unsaved changes; allow leaving if no edits were made
window.addEventListener('beforeunload', function (e) {
  try {
    if (window.__formIsDirty) {
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  } catch {}
});

// Also restore styles on afterprint event (cross-browser safety)
window.addEventListener('afterprint', () => {
  const inputs = document.querySelectorAll('.fillable');
  inputs.forEach(input => {
    input.style.color = '';
  });
});
</script>
</body>
</html>

